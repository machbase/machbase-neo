---
layout: default
parent: Bridges
title: Bridge - MQTT
nav_order: 21
has_children: false
---

# Birdge - MQTT
{: .no_toc}

1. TOC
{: toc}

## Register a bridge to an external MQTT broker

Register a bridge

```
bridge add -t mqtt my_mqtt broker=127.0.0.1:1883 id=client-id;
```

A mqtt bridge just defines how machbase-neo can connect to the external MQTT broker,
See the [Subscriber](../subscriber/00.index.md) to get it receiving messages.

Available connect options

| Option           | Description                          | example         |
| :-----------     | :---------------------------------   | :-------------  |
| `broker`         | brokder address, If the broker has redundant access points, use multiple "broker" options | `broker=192.0.1.100:1883` |
| `id`             | client id                            |                 |
| `username`       | username                             |                 |
| `password`       | password                             |                 |
| `keepalive`      | keepalive in duration format         | `keepalive=30s` |
| `clieansession`  | cleansesion                          | `cleansession=1` `cleansession=false` |
| `cafile`         | ca cert (`*.pem`) file path            |  *TLS*          |
| `key`            | client private key (`*.pem`) file path |  *TLS*          |
| `cert`           | client certificate (`*.pem`) file path |  *TLS*          |

> When all three of `cafile`, `key`, `cert` options are set, the secure mqtt connection is enabled with TLS.

## Send messages

Run `mosuqitto_sub` with debug mode (`-d`) option.
This will receive messages from topic 'neo/messages' via mosquitto broker
when machbase-neo publish messages to the topic.

```sh
mosquitto_sub -d -h 127.0.0.1 -p 1883 -i client-app -t neo/messages                                            1 ↵
Client client-app sending CONNECT
Client client-app received CONNACK (0)
Client client-app sending SUBSCRIBE (Mid: 1, Topic: neo/messages, QoS: 0, Options: 0x00)
Client client-app received SUBACK
Subscribed (mid: 1): 0
```

Make a *TQL* script that call the `publish()` function of the bridge.

```js
FAKE(linspace(0,10, 5))
SCRIPT({
  ctx := import("context")
  br := ctx.bridge("my_mqtt")
  br.publish("neo/messages", "The message numser is "+ctx.value(0))
  ctx.yieldKey(ctx.key(), ctx.value()...)
})
CSV()
```

As soon as executing the script avivem the `mosquitto_sub` prints out tge messages on the screen.

```sh
mosquitto_sub -d -h 127.0.0.1 -p 1883 -i client-app -t neo/messages                                            1 ↵
... omit ...
Client client-app received PUBLISH (d0, q0, r0, m0, 'neo/messages', ... (23 bytes))
The message numser is 0
Client client-app received PUBLISH (d0, q0, r0, m0, 'neo/messages', ... (25 bytes))
The message numser is 2.5
Client client-app received PUBLISH (d0, q0, r0, m0, 'neo/messages', ... (23 bytes))
The message numser is 5
Client client-app received PUBLISH (d0, q0, r0, m0, 'neo/messages', ... (25 bytes))
The message numser is 7.5
Client client-app received PUBLISH (d0, q0, r0, m0, 'neo/messages', ... (24 bytes))
The message numser is 10
```

## Receive messages

Configure a [subscriber](../subscriber/00.index.md) to receive messages from the broker.
